<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SecureChat</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>

  <!-- CryptoJS (AES) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body class="bg-slate-50 dark:bg-slate-900 min-h-screen flex items-center justify-center p-2 md:p-4 transition-colors duration-300">
<main class="w-full h-screen md:h-[85vh] md:max-w-7xl bg-white dark:bg-slate-800 shadow-lg md:rounded-2xl overflow-hidden grid grid-cols-1 md:grid-cols-3 transition-colors duration-300">

    <!-- Sidebar -->
    <aside class="md:col-span-1 border-r border-slate-100 dark:border-slate-700 p-4 flex flex-col">

      <header class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-slate-800 dark:text-white">SecureChat</h2>
        <div class="flex gap-2">
          <!-- Settings icon -->
          <a href="settings.html">
            <button id="iconset" class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xl transition hover:scale-110">
              ‚öôÔ∏è
            </button>
          </a>
          <!-- Theme toggle -->
          <button id="themeToggle" class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xl transition hover:scale-110">
            üåô
          </button>
        </div>
      </header>

      <!-- Avatar, username, and status -->
      <div class="flex items-center gap-3 mb-4">
        <img id="avatar" class="w-12 h-12 rounded-full object-cover" src="" alt="Avatar">
        <div>
          <div id="usernameDisplay" class="font-semibold text-slate-800 dark:text-white">Loading...</div>
          <div id="statusDisplay" class="text-xs text-slate-500 dark:text-slate-400">Loading...</div>
        </div>
      </div>

      <div class="mt-2 mb-4">
        <label class="text-xs text-slate-500 dark:text-slate-400">Encryption</label>
        <div class="flex items-center gap-2 mt-1">
          <div id="encryptionIndicator" class="flex items-center gap-2 text-xs font-medium text-green-600 dark:text-green-400">
            üîí End-to-end encrypted
          </div>
        </div>
      </div>

      <div class="flex gap-2 p-2 border-b border-slate-300 dark:border-slate-600 mb-2">
        <input id="searchInput" type="text" placeholder="Search user..." 
        class="flex-1 rounded-md border border-slate-300 dark:border-slate-600 px-2 py-1 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="searchBtn"
          class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700">Search</button>
      </div>

      <div class="flex-1 overflow-hidden flex flex-col">
        <h3 class="text-sm px-2 py-2 font-medium text-slate-700 dark:text-slate-300">Chats</h3>
        <div id="usersList" class="space-y-2 flex-1 overflow-auto"></div>
      </div>

      <footer class="mt-auto text-xs text-slate-400 pt-4 border-t border-slate-100 dark:border-slate-700">
        <div>Device: Web ‚Ä¢ Secure transport: TLS</div>
      </footer>

    </aside>

    <!-- Chat area -->
    <section class="md:col-span-2 bg-gray-50 dark:bg-slate-900 flex flex-col">

      <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
        <div id="chatHeader" class="font-semibold text-lg text-slate-700 dark:text-white">
          Select a user to start chatting
        </div>

        <button id="clearChatBtn" class="px-3 py-1 text-xs bg-red-400 text-white rounded-md hover:bg-red-500">
          Clear Chat
        </button>
      </div>

      <div id="messages" class="flex-1 p-4 overflow-auto space-y-3 bg-gradient-to-b from-white via-slate-50 to-white dark:from-slate-800 dark:via-slate-900 dark:to-slate-900 transition-colors duration-300">
        <p class="text-center text-slate-400 mt-4">Start a secure chat</p>
      </div>

      <div class="p-3 border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex items-center gap-2">
        <input id="inputMessage" type="text" placeholder="Type a message..."
          class="flex-1 rounded-xl border border-slate-200 dark:border-slate-600 px-4 py-2 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="sendBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700">
          Send
        </button>
      </div>

    </section>
  </main>

<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  serverTimestamp,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAdQikqsyjWy43B1mqS4kEQhHWGhhmJdGk",
  authDomain: "chat-d8ef1.firebaseapp.com",
  projectId: "chat-d8ef1",
  storageBucket: "chat-d8ef1.firebasestorage.app",
  messagingSenderId: "591457470644",
  appId: "1:591457470644:web:2f963eced0c097b349efe1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* =========================================================
  Demo E2EE: symmetric key derived from chatId + APP_SALT
=========================================================*/
const APP_SALT = "demo_app_salt_replace_with_real_key_exchange";

function deriveKeyFromChatId(chatId) {
  return CryptoJS.SHA256(chatId + ":" + APP_SALT);
}

function encryptWithDerivedKey(chatId, plainText) {
  const key = deriveKeyFromChatId(chatId);
  const iv = CryptoJS.lib.WordArray.random(16);
  const encrypted = CryptoJS.AES.encrypt(plainText, key, {
    iv: iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7
  });
  return {
    ciphertext: encrypted.toString(),
    iv: iv.toString(CryptoJS.enc.Base64)
  };
}

function decryptWithDerivedKey(chatId, ciphertextBase64, ivBase64) {
  try {
    const key = deriveKeyFromChatId(chatId);
    const iv = CryptoJS.enc.Base64.parse(ivBase64);
    const bytes = CryptoJS.AES.decrypt(ciphertextBase64, key, {
      iv: iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    const plain = bytes.toString(CryptoJS.enc.Utf8);
    return plain || null;
  } catch (e) {
    return null;
  }
}

/* =========================================================
  DOM Elements
=========================================================*/
const themeBtn = document.getElementById("themeToggle");
const usernameDisplay = document.getElementById('usernameDisplay');
const statusDisplay = document.getElementById('statusDisplay');
const avatar = document.getElementById('avatar');
const usersListEl = document.getElementById('usersList');
const chatHeaderEl = document.getElementById('chatHeader');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('inputMessage');
const sendBtn = document.getElementById('sendBtn');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearChatBtn = document.getElementById('clearChatBtn');

let currentUser = null;
let userData = {};
let currentChatUser = null;
let unsubscribeMessages = null;
let unsubscribeUserData = null;

/* =========================================================
  Theme Management
=========================================================*/
function applyTheme(theme) {
  const isDark = theme === "dark";
  document.documentElement.classList.toggle("dark", isDark);
  if (themeBtn) {
    themeBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  }
}

if (themeBtn) {
  themeBtn.onclick = async () => {
    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    applyTheme(newTheme);
    
    if (currentUser) {
      try {
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("uid", "==", currentUser.uid));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
          const userDocId = snapshot.docs[0].id;
          await updateDoc(doc(db, "users", userDocId), {
            theme: newTheme,
            updatedAt: serverTimestamp()
          });
        }
      } catch (error) {
        console.error("Error updating theme:", error);
      }
    }
  };
}

/* =========================================================
  Update UI with user data
=========================================================*/
function updateUserUI(data) {
  if (data.username && usernameDisplay) {
    usernameDisplay.textContent = data.username;
  }
  
  if (statusDisplay) {
    statusDisplay.textContent = data.status || 'Hey there! I am using SecureChat';
  }
  
  if (avatar) {
    if (data.photoURL) {
      avatar.src = data.photoURL;
    } else {
      const username = data.username || 'U';
      avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=random`;
    }
  }
  
  if (data.theme) {
    applyTheme(data.theme);
  }
}

/* =========================================================
  Auth listener with real-time user data updates
=========================================================*/
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    if (unsubscribeUserData) unsubscribeUserData();
    window.location.href = 'index.html';
    return;
  }
  
  currentUser = user;

  try {
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("uid", "==", user.uid));
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      const userDocId = snapshot.docs[0].id;
      const userDocRef = doc(db, "users", userDocId);
      
      // Real-time listener for user data
      unsubscribeUserData = onSnapshot(userDocRef, (docSnapshot) => {
        if (docSnapshot.exists()) {
          userData = docSnapshot.data();
          updateUserUI(userData);
        }
      }, (error) => {
        console.error("Error listening to user data:", error);
      });
    }
    
    // Load chat users
    await loadChatUsers();
    
  } catch (error) {
    console.error("Error loading user data:", error);
  }
});

/* =========================================================
  Load chat users (users with message history)
=========================================================*/
async function loadChatUsers() {
  if (!currentUser) return;
  
  usersListEl.innerHTML = "<p class='text-slate-400 text-sm text-center px-2'>Loading...</p>";

  try {
    const usersRef = collection(db, "users");
    const snap = await getDocs(usersRef);
    const allUsers = snap.docs.map(d => d.data()).filter(u => u.username);

    const chatUsers = [];
    for (const u of allUsers) {
      if (u.uid === currentUser.uid) continue;
      
      const chatId = [currentUser.uid, u.uid].sort().join("_");
      const messagesRef = collection(db, "chats", chatId, "messages");
      const mSnap = await getDocs(messagesRef);
      
      if (!mSnap.empty) {
        chatUsers.push(u);
      }
    }

    usersListEl.innerHTML = "";
    
    if (!chatUsers.length) {
      usersListEl.innerHTML = "<p class='text-slate-400 text-sm text-center px-2 mt-4'>No chats yet. Search for a user to start chatting.</p>";
      return;
    }

    chatUsers.forEach(u => {
      const div = document.createElement("div");
      div.className = "p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border border-slate-200 dark:border-slate-600 transition";
      
      const userAvatar = u.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.username || 'U')}&background=random&size=32`;
      
      div.innerHTML = `
        <div class="flex items-center gap-2">
          <img src="${userAvatar}" class="w-8 h-8 rounded-full object-cover" alt="${escapeHtml(u.username)}">
          <span class="font-medium text-slate-800 dark:text-white">${escapeHtml(u.username)}</span>
        </div>
      `;
      
      div.onclick = () => selectChat(u);
      usersListEl.appendChild(div);
    });
  } catch (error) {
    console.error("Error loading chat users:", error);
    usersListEl.innerHTML = "<p class='text-red-400 text-sm text-center px-2'>Error loading chats</p>";
  }
}

/* =========================================================
  Select chat and load messages
=========================================================*/
function selectChat(user) {
  currentChatUser = user;
  chatHeaderEl.textContent = user.username;
  messagesEl.innerHTML = "<p class='text-slate-400 text-sm text-center'>Loading messages...</p>";

  if (unsubscribeMessages) unsubscribeMessages();

  const chatId = [currentUser.uid, currentChatUser.uid].sort().join("_");
  const messagesRef = collection(db, "chats", chatId, "messages");
  const q = query(messagesRef, orderBy("timestamp"));

  unsubscribeMessages = onSnapshot(q, snapshot => {
    displayMessages(snapshot);
  }, (err) => {
    console.error("Messages error:", err);
    messagesEl.innerHTML = "<p class='text-red-400 text-sm text-center'>Error loading messages</p>";
  });
}

/* =========================================================
  Display messages with E2E decryption
=========================================================*/
function displayMessages(snapshot) {
  messagesEl.innerHTML = "";

  if (snapshot.empty) {
    messagesEl.innerHTML = "<p class='text-center text-slate-400 mt-4'>Start chatting securely! üîí</p>";
    return;
  }

  snapshot.docs.forEach(docItem => {
    const msg = docItem.data();
    const isSender = msg.sender === currentUser.uid;

    const wrapper = document.createElement("div");
    wrapper.className = "mb-2 flex flex-col";

    const bubble = document.createElement("div");
    bubble.className = (isSender
      ? "bg-indigo-600 text-white rounded-tl-2xl rounded-tr-xl rounded-bl-2xl px-4 py-2 max-w-[70%] self-end shadow-sm"
      : "bg-gray-200 dark:bg-slate-700 text-gray-900 dark:text-white rounded-tl-xl rounded-tr-2xl rounded-br-2xl px-4 py-2 max-w-[70%] self-start shadow-sm");

    // Decrypt message
    let displayText = "";
    if (msg.encrypted && msg.ciphertext && msg.iv) {
      const chatId = [currentUser.uid, currentChatUser.uid].sort().join("_");
      const plain = decryptWithDerivedKey(chatId, msg.ciphertext, msg.iv);
      displayText = plain !== null ? plain : "[Unable to decrypt]";
    } else if (msg.text) {
      displayText = msg.text;
    } else {
      displayText = "[Unsupported message]";
    }

    const textNode = document.createElement("div");
    textNode.className = "break-words";
    textNode.textContent = displayText;
    bubble.appendChild(textNode);

    const timeRow = document.createElement("div");
    timeRow.className = "flex items-center mt-1";
    
    const timeEl = document.createElement("div");
    timeEl.className = "text-[11px] text-slate-500 dark:text-slate-400";
    
    const t = msg.timestamp ? (msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp)) : new Date();
    timeEl.textContent = t.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    if (isSender) {
      timeRow.classList.add("justify-end");
      timeRow.appendChild(timeEl);
    } else {
      timeRow.classList.add("justify-start");
      timeRow.appendChild(timeEl);
    }

    wrapper.appendChild(bubble);
    wrapper.appendChild(timeRow);
    messagesEl.appendChild(wrapper);
  });

  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* =========================================================
  Send encrypted message
=========================================================*/
sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});

async function sendMessage() {
  if (!currentChatUser) {
    alert("Select a user first!");
    return;
  }
  
  const text = inputEl.value.trim();
  if (!text) return;

  const chatId = [currentUser.uid, currentChatUser.uid].sort().join("_");
  const enc = encryptWithDerivedKey(chatId, text);

  try {
    const messagesRef = collection(db, "chats", chatId, "messages");
    await addDoc(messagesRef, {
      sender: currentUser.uid,
      ciphertext: enc.ciphertext,
      iv: enc.iv,
      encrypted: true,
      timestamp: serverTimestamp()
    });

    inputEl.value = "";
    await loadChatUsers();
  } catch (error) {
    console.error("Error sending message:", error);
    alert("Failed to send message");
  }
}

/* =========================================================
  Search user
=========================================================*/
searchBtn.onclick = async () => {
  const term = searchInput.value.trim().toLowerCase();
  if (!term) {
    alert("Enter a username!");
    return;
  }

  try {
    const snap = await getDocs(collection(db, "users"));
    const users = snap.docs.map(d => d.data());

    const found = users.find(u =>
      u.username && u.username.toLowerCase().includes(term) && u.uid !== currentUser.uid
    );

    if (!found) {
      alert("User not found!");
      return;
    }
    
    selectChat(found);
    searchInput.value = "";
  } catch (error) {
    console.error("Error searching user:", error);
    alert("Search failed");
  }
};

/* =========================================================
  Clear chat
=========================================================*/
clearChatBtn.onclick = async () => {
  if (!currentChatUser) {
    alert("Select a user first!");
    return;
  }
  
  if (!confirm("Clear this conversation?")) return;

  try {
    const chatId = [currentUser.uid, currentChatUser.uid].sort().join("_");
    const messagesRef = collection(db, "chats", chatId, "messages");
    const snap = await getDocs(messagesRef);
    
    for (const d of snap.docs) {
      await deleteDoc(doc(db, "chats", chatId, "messages", d.id));
    }
    
    messagesEl.innerHTML = "<p class='text-center text-slate-400 mt-4'>Chat cleared.</p>";
    await loadChatUsers();
  } catch (error) {
    console.error("Error clearing chat:", error);
    alert("Failed to clear chat");
  }
};

/* =========================================================
  Cleanup on page unload
=========================================================*/
window.addEventListener('beforeunload', () => {
  if (unsubscribeUserData) unsubscribeUserData();
  if (unsubscribeMessages) unsubscribeMessages();
});

/* =========================================================
  Helper function
=========================================================*/
function escapeHtml(s) {
  if (!s) return s;
  return s.replace(/[&<>"'`=\/]/g, function (c) {
    return ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
      "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
    })[c];
  });
}
</script>
</body>
</html>
